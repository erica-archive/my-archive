<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>View Entry â€” My Archive</title>
  <link rel="stylesheet" href="css/style.css" />
  <link href="https://fonts.googleapis.com/css2?family=Lora:ital,wght@0,400;0,600;1,400&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
</head>
<body>

  <nav class="navbar">
    <a href="index.html" class="nav-logo">ğŸ“š My Archive</a>
    <div class="nav-links">
      <a href="index.html">Home</a>
      <a href="add.html">+ Add Entry</a>
      <button id="themeToggle" class="theme-btn" title="Toggle dark mode">ğŸŒ™</button>
    </div>
  </nav>

  <main class="container view-page">
    <div class="view-card" id="viewCard">
      <p style="color:var(--text-muted); font-style:italic;">â³ Loading entry...</p>
    </div>
  </main>

  <footer class="footer">
    <p>Built with â™¥ â€” your personal second brain.</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/config.js"></script>
  <script src="js/theme.js"></script>
  <script src="js/photos.js"></script>
  <script src="js/app.js"></script>
  <script>
    const params  = new URLSearchParams(window.location.search);
    const entryId = params.get('id');
    const card    = document.getElementById('viewCard');

    async function loadEntry() {
      if (!entryId) {
        card.innerHTML = `<p>No entry ID found. <a href="index.html">â† Go back</a></p>`;
        return;
      }

      // Fetch this single entry from Supabase
      const { data, error } = await db
        .from('entries')
        .select('*')
        .eq('id', entryId)
        .single();

      if (error || !data) {
        card.innerHTML = `<p>Entry not found. <a href="index.html">â† Go back</a></p>`;
        return;
      }

      const entry = data;
      document.title = entry.title + ' â€” My Archive';

      // Get photo URL if entry has a photo
      let photoUrl = null;
      if (entry.has_photo && entry.photo_path) {
        photoUrl = getPhotoUrlFromPath(entry.photo_path);
      }

      const tags = entry.tags ? entry.tags.split(',').filter(t => t !== '') : [];

      card.innerHTML = `
        <div class="view-header">
          <a href="index.html" class="back-link">â† Back to Archive</a>
          <span class="entry-type-badge">${typeEmoji[entry.type] || 'ğŸ“„'} ${entry.type}</span>
        </div>

        <h1 class="view-title">${entry.title}</h1>
        <p class="view-date">${entry.date}</p>

        ${photoUrl
          ? `<img src="${photoUrl}" alt="${entry.title}" class="view-photo" />`
          : ''}

        ${entry.content
          ? `<div class="view-content">${entry.content.replace(/\n/g, '<br/>')}</div>`
          : ''}

        ${entry.url
          ? `<a href="${entry.url}" target="_blank" class="view-link">ğŸ”— Open link: ${entry.url}</a>`
          : ''}

        ${tags.length > 0
          ? `<div class="view-tags">
               ${tags.map(t => `<span class="tag">#${t}</span>`).join('')}
             </div>`
          : ''}

        <div class="view-actions">
          <button class="btn-danger" id="deleteBtn">ğŸ—‘ Delete Entry</button>
        </div>
      `;

      document.getElementById('deleteBtn').addEventListener('click', async function () {
        if (!confirm('Are you sure you want to delete this entry? This cannot be undone.')) return;
        this.textContent = 'Deleting...';
        this.disabled = true;
        try {
          // Delete photo from storage if it exists
          if (entry.has_photo && entry.photo_path) {
            await db.storage.from('photos').remove([entry.photo_path]);
          }
          // Delete entry from database
          await db.from('entries').delete().eq('id', entryId);
          window.location.href = 'index.html';
        } catch (err) {
          alert('Could not delete entry: ' + err.message);
          this.textContent = 'ğŸ—‘ Delete Entry';
          this.disabled = false;
        }
      });
    }

    loadEntry();
  </script>
</body>
</html>
